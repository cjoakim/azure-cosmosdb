# CosmosDB / Mongo API, 2020/03/15

## Turn-Key Global Distribution

- https://docs.microsoft.com/en-us/azure/cosmos-db/distribute-data-globally
- Applies to **all** CosmosDB APIs

---

## Multi-Region Write Capability

- Applies to **all** CosmosDB APIs

### Consistency: How the CosmosDB SQL API does this

#### Consistency Levels

- https://docs.microsoft.com/en-us/azure/cosmos-db/sql/how-to-manage-consistency


#### OCC - optimistic concurrency control

- https://docs.microsoft.com/en-us/azure/cosmos-db/sql/database-transactions-optimistic-concurrency
- Uses the system-generated **_etag** attribute
- Defaults to "Last Write Wins"
- You can override this on a custom attribute

Sample Document with the System-generated **_etag** and **_ts** attributes:

```
{
    "customer_id": 199,
    "first_name": "Veronica",
    "last_name": "Gilbert",
    "full_name": "Veronica Gilbert",
    "address": "6292 Cervantes Port",
    "city": "West Joseph",
    "state": "IA",
    "doc_epoch": 1644166252599,
    "doc_time": "2022/02/06-16:50:52",
    "id": "2503a58f-0902-4344-8874-7fbe5d2073fb",
    "pk": 199,
    "_rid": "OpdUAKTYP9kDAAAAAAAAAA==",
    "_self": "dbs/OpdUAA==/colls/OpdUAKTYP9k=/docs/OpdUAKTYP9kDAAAAAAAAAA==/",
    "_etag": "\"940514bd-0000-0100-0000-61fffc6d0000\"",
    "_attachments": "attachments/",
    "_ts": 1644166253
}
```

### Consistency: How to do this with the CosmosDB Mongo API

Sample Document - no etag!

```
{
	"_id" : ObjectId("622e0a774a161737563ea279"),
	"airline_id" : "2",
	"name" : "135 Airways",
	"iata" : "",
	"icao" : "GNL",
	"callsign" : "GENERAL",
	"country" : "United States",
	"active" : "N",
	"pk" : "2",
	"doctype" : "airline"
}
```

- Spring Data OCC
  - https://docs.spring.io/spring-data/mongodb/docs/current/reference/html/#reference

```
@Document
class Person {

  @Id String id;
  String firstname;
  String lastname;
  @Version Long version;  // <-- Spring Data @Version annotation for OCC
}
```

- https://docs.mongodb.com/manual/faq/concurrency/
  - "allows operations to lock at the global, database or collection level"

- https://jimmybogard.com/document-level-optimistic-concurrency-in-mongodb/ 
  - "Mongo has locks at the global, database, or collection level, but **not** at the document level"
